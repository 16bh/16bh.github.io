<!DOCTYPE html>
<html lang="zh-CN">

  
<head>
  <meta charset="utf-8">
  <meta name="author" content="å°å‡¡, xujun_njupt@126.com" />
  
  

  <title>[è¯‘]Magentoä¸­çš„12ç§è®¾è®¡æ¨¡å¼ | å‡¡Â·é—´</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="IT,magento,è®¾è®¡æ¨¡å¼," />
  

  <script>
    console.log('\n%c Hexo-theme-bmw v4.0 ' + '%c ğŸ‰ https://github.com/dongyuanxin/theme-bmw ğŸ‰\n' + '\n%c View demo online ' + '%c ğŸ” https://godbmw.com/ ğŸ”  \n' , 'color: #fadfa3; background: #030307; padding:3px 0;', '', 'color: #fadfa3; background: #030307; padding:3px 0;', '');
  </script>

  

  

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/icon/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">

  <script src="/js/util.js"></script>
<script src="/js/valine.min.js"></script>

  

  

  
    <link href="https://cdn.bootcss.com/social-share.js/1.0.16/css/share.min.css" rel="stylesheet">
  

  <script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js" async></script>

  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script>
  

</head>


  <body>

    

    <div id="app">

      <div class="header-wrap">
  <header>
    <div class="site-brand">
      <div class="site-title">
        <a href="/">å‡¡Â·é—´</a>
      </div>
    </div>
    <nav class="site-navigation">
      <ul class="nav-menu">
      
        <li class="nav-item" data-path="/">
          
            <a 
              href="/"
              target="_self"
            >
              ä¸»é¡µ
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/archives/">
          
            <a 
              href="/archives/"
              target="_self"
            >
              å½’æ¡£
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/categories/">
          
            <a 
              href="/categories/"
              target="_self"
            >
              åˆ†ç±»
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/tags/">
          
            <a 
              href="/tags/"
              target="_self"
            >
              æ ‡ç­¾
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/about/">
          
            <a 
              href="/about/"
              target="_self"
            >
              å…³äº
            </a>
          
        </li>
      
      </ul>
    </nav>
    <i class="iconfont icon-menu"></i>
  </header>
</div>

<script>
  let links = document.querySelectorAll('.nav-item');
  for(let link of links){
    let childrenLink = link.querySelector('ul');
    link.addEventListener('mouseenter', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown active";
      }
    })
    link.addEventListener('mouseleave', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown";
      }
    })
  }
  let rootRealPath = getRealPath(window.location.pathname, true);
  for(let link of links) {
    let linkPath = link.getAttribute("data-path");
    if(linkPath && getRealPath(linkPath, true) === rootRealPath) {
      link.className = "nav-item hover";
    }
  }

  let iconMenu = document.querySelector("i.iconfont.icon-menu"),
    iconMenuClicked = false;
  let navDOM = document.querySelector("nav.site-navigation");
  iconMenu.addEventListener("click", () => {
    iconMenuClicked 
      ? navDOM.className = "site-navigation active"
      : navDOM.className = "site-navigation";
    iconMenuClicked = !iconMenuClicked;
  })
</script>

      








<div class="container post-index">

  

<div class="post">
  <h1 class="article-title">
    <span>[è¯‘]Magentoä¸­çš„12ç§è®¾è®¡æ¨¡å¼</span>
  </h1>
  <div class="article-top-meta">
    <span>
      å‘å¸ƒ : 
      2017-03-30
    </span>
    
      <span>
        åˆ†ç±» : 
          <a href="/categories/IT/">
            IT
          </a>
      </span>
    
    
      <span>
        æµè§ˆ : <span class="article-timer" data-identity="12-design-patterns-in-magento"></span>
      </span>
    
  </div>

  

  <div class="article-content">
    <div class="markdown-body">
      <p>Magentoä¸­çš„æ¶æ„é€šå¸¸è¢«è®¤ä¸ºæ˜¯è¿‡åº¦è®¾è®¡äº†ã€‚å¦‚æœä»æ¶æ„çš„è§’åº¦å»çœ‹Magentoçš„ä»£ç ï¼Œå¾ˆå®¹æ˜“å‘ç°å®ƒè‡³å°‘ä½¿ç”¨äº†ä¸‹é¢ä»‹ç»çš„çš„åäºŒç§è®¾è®¡æ¨¡å¼ã€‚</p>
<blockquote>
<p>Magento its architecture is sometimes deemed overly engineered. If we look at it from a helicopter view, commonly used design patterns are easily spotted. Here are 12 of them.</p>
</blockquote>
<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>ç»™å‡ºä¸€ä¸ªéœ€æ±‚ï¼Œè§£å†³çš„æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œè®¾è®¡æ¨¡å¼ä¾¿æ˜¯å…¶ä¸­çš„æœ€ä½³æ–¹æ³•ï¼Œå¯ä»¥è§£å†³ç‰¹å®šç¯å¢ƒä¸‹çš„åŒç±»é—®é¢˜ã€‚è®¾è®¡æ¨¡å¼çš„ä»£ç æ˜¯å¯é‡å¤åˆ©ç”¨çš„ï¼Œå¯¹äºæé«˜å·¥ä½œæ•ˆç‡å¤§æœ‰è£¨ç›Šï¼Œé‚£ä»é•¿è¿œè§’åº¦è€ƒè™‘ï¼Œæ˜¯ä¸æ˜¯åº”å½“åœ¨ä»£ç ä¸­å°½å¯èƒ½å¤šçš„ä½¿ç”¨è®¾è®¡æ¨¡å¼å‘¢ï¼Ÿæ˜æ˜¾ä¸æ˜¯ï¼Œä¸€åä¼˜ç§€çš„è½¯ä»¶å¼€å‘è€…çŸ¥é“ä½•æ—¶ä½¿ç”¨è®¾è®¡æ¨¡å¼ï¼Œå¹¶ä¸ä¼šæ— çš„æ”¾çŸ¢ã€‚æ—©æœŸMagentoæ¡†æ¶ä¸­çš„æ¯”è¾ƒå‡ºè‰²çš„ä¸€ç‚¹æ˜¯ï¼Œå…¶ä¸­çš„ç»å¤§éƒ¨åˆ†ï¼ˆç”šè‡³æ‰€æœ‰ï¼‰ä½¿ç”¨çš„è®¾è®¡æ¨¡å¼çš„æ–¹å¼éƒ½æœ‰å…¶ç”¨æ„æ‰€åœ¨ï¼ˆç”»å¤–éŸ³ï¼šè¯´æ˜Magentoçš„å¼€å‘è€…æ˜¯ä¸€åä¼˜ç§€çš„è½¯ä»¶å¼€å‘è€…ï¼Œä¸ç„¶æœ¬æ–‡ä¹Ÿå°±æ²¡æœ‰æ„ä¹‰äº†ï¼‰ã€‚</p>
<p>æœ¬æ–‡æ˜¯æ ¹æ®@Ryan Streetçš„ç³»åˆ—åšæ–‡æ•´ç†è€Œå¾—çš„ã€‚</p>
<blockquote>
<p>Introduction</p>
<p>A software design pattern is a reusable solution to an often occurring problem. This doesnâ€™t mean that software is better if it has more design patterns. Instead, a good software engineer should be able to spot the problem and implement the pattern instead of introducing implementations without purpose. The earlier behavior is leadingly noticeable in Magento, where most if not all design pattern-implementations have a purpose.<br>This is a compilation of an article-series which originally appeared on Ryan Streetâ€™s blog (@ryanstreet).</p>
</blockquote>
<h2 id="æ¨¡å¼1ï¼šMVC"><a href="#æ¨¡å¼1ï¼šMVC" class="headerlink" title="æ¨¡å¼1ï¼šMVC"></a>æ¨¡å¼1ï¼šMVC</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿ï£¿</p>
<p>Model-View-Controller,å³æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨,ç®€ç§°MVCï¼Œåº”è¯¥æ˜¯æœ€å¹¿ä¸ºäººçŸ¥çš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼ˆå¤§å¤šæ•°ä½¿ç”¨è€…ç”šè‡³éƒ½ä¸ä¼šå°†å®ƒè§†ä¸ºè®¾è®¡æ¨¡å¼ï¼‰ã€‚</p>
<p>è¿™æ˜¯ä¸€ç§å°†ä¸šåŠ¡é€»è¾‘ã€é¡µé¢å±•ç¤ºã€é€»è¾‘åˆ†ç¦»å¼€æ¥çš„è®¾è®¡æ¨¡å¼ã€‚Magenoä¸­ä½¿ç”¨äº†å¤§é‡çš„xmlæ–‡ä»¶ä½œä¸ºé€»è¾‘æ¨¡æ¿ï¼Œä½¿ç”¨pthmlï¼ˆæ··åˆäº†HTMLå’ŒPHPï¼‰æ–‡ä»¶ä½œä¸ºå®ƒçš„è§†å›¾ï¼Œå‰©ä¸‹çš„æ¨¡å‹ä¾èµ–Variençš„ORMã€‚å¤§å¤šæ•°çš„ä¸šåŠ¡é€»è¾‘å‘ç”Ÿåœ¨æ¨¡å‹ä¸­ï¼Œè€Œæ§åˆ¶å™¨å°†æ¨¡å‹æ•°æ®æ˜ å°„åˆ°è§†å›¾ï¼ŒMagentoçš„è§†å›¾åŒ…å«äº†å¤ªå¤šçš„é€»è¾‘è€Œæ˜¾ç¤ºå¾ˆç¬¨é‡ï¼Œä¸å¾—ä¸é€šè¿‡ä¸€ä¸ªä¸“é—¨çš„phpç±»ï¼ˆBlockç±»ï¼‰è¿›è¡Œæ¸²æŸ“ã€‚</p>
<blockquote>
<p>Model View Controller Pattern</p>
<p>Model View Controller, MVC for short, is a design pattern where business, presentation and coupling logic are separated. Magento heavily utilizes XML as templating-logic and HTML mixed with PHP files for its views. Models are backed by ORM. Most business logic happens in the models whereas the controllers map the model-data to the views.<br>Because Magento its views are â€œfatâ€ â€“ they often contain a lot of logic â€“ its not rare that views have an additional PHP class (the Block system) which will help with rendering</p>
</blockquote>
<h2 id="æ¨¡å¼2ï¼š-å‰ç«¯æ§åˆ¶å™¨æ¨¡å¼"><a href="#æ¨¡å¼2ï¼š-å‰ç«¯æ§åˆ¶å™¨æ¨¡å¼" class="headerlink" title="æ¨¡å¼2ï¼š å‰ç«¯æ§åˆ¶å™¨æ¨¡å¼"></a>æ¨¡å¼2ï¼š å‰ç«¯æ§åˆ¶å™¨æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿ï£¿</p>
<p>å‰ç«¯æ§åˆ¶å™¨æ¨¡å¼ç¡®ä¿æœ‰ä¸”åªæœ‰ä¸€ä¸ªå…¥å£ã€‚æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå…ˆä»å‰ç«¯æ§åˆ¶å™¨é‚£é‡Œèµ°ä¸€é­ï¼Œè¢«è¯†åˆ«åè·¯ç”±åˆ†å‘åˆ°æŒ‡å®šçš„controllerï¼Œè¿›è¡Œç‰¹å®šçš„å¤„ç†ã€‚<br>åœ¨Magentoå”¯ä¸€ä¸€ä¸ªå…¥å£æ–‡ä»¶<code>index.php</code>å°±èµ·åˆ°äº†å‰ç«¯æ§åˆ¶å™¨çš„ä½œç”¨ï¼Œå®ƒé€šè¿‡<code>Mage::app()</code>æ–¹æ³•å®ç°åº”ç”¨ç¯å¢ƒçš„åˆå§‹åŒ–å¹¶å°†è¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„controllerä¸­ã€‚</p>
<blockquote>
<p>Front Controller Pattern</p>
<p>The front controller pattern makes sure that there is one and only one point of entry. All requests are investigated, routed to the designated controller and then processed accordingly to the specification. The front controller is responsible of initializing the environment and routing requests to designated controllers.<br>Magento has only one point of entry (index.php) which will initialize the application environment (Mage::app()) and route the request to the correct controller.</p>
</blockquote>
<h2 id="æ¨¡å¼3ï¼šå·¥å‚æ¨¡å¼"><a href="#æ¨¡å¼3ï¼šå·¥å‚æ¨¡å¼" class="headerlink" title="æ¨¡å¼3ï¼šå·¥å‚æ¨¡å¼"></a>æ¨¡å¼3ï¼šå·¥å‚æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿ï£¿<br>å·¥å‚æ¨¡å¼çš„â€œå·¥å‚â€äºŒå­—å·²ç»å……åˆ†è¡¨éœ²äº†å®ƒçš„åŠŸèƒ½â€”â€”â€”â€”å¦‚å·¥å‚çš„æµæ°´çº¿ä¸€èˆ¬ç»Ÿä¸€è¿›è¡Œç±»çš„å®ä¾‹åŒ–ã€‚</p>
<p>å®ƒè¢«å¹¿æ³›åº”ç”¨åœ¨Magentoçš„ä»£ç åº“ä¸­ï¼Œè´Ÿè´£è‡ªåŠ¨åŠ è½½ç³»ç»Ÿã€‚åœ¨<code>config.xml</code>æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ª<code>module</code>çš„åˆ«ååï¼Œå·¥å‚å°±æ‚„å’ªå’ªçš„è®°å½•äº†åˆ«åå¯¹åº”çš„ç±»åŠç±»æ‰€åœ¨çš„ä½ç½®ã€‚</p>
<p><code>Mage</code>æ ¸å¿ƒç±»ä¸­æœ‰å¾ˆå¤šè¾…åŠ©å®ç°å·¥å‚çš„æ–¹æ³•ï¼Œå…¶ä¸­çš„<code>Mage::getModel()</code>æ–¹æ³•å¯ä»¥æ¥æ”¶ä¸€ä¸ªç±»çš„åˆ«åè¿”å›ç±»çš„å®ä¾‹ï¼Œå¦‚<code>Mage::getModel(&#39;catalog/product&#39;)</code>è¿”å›äº§å“ç±»<code>Mage_Catalog_Model_Product</code>çš„å®ä¾‹ã€‚</p>
<p>åŒºåˆ«äºä¼ ç»Ÿçš„åœ¨ä»£ç ä¸­ç›´æ¥å¼•å…¥ç±»æ‰€åœ¨æ–‡ä»¶å¹¶è°ƒç”¨ç±»ï¼Œå·¥å‚æ¨¡å¼ä»¥ç»Ÿä¸€çš„æ–¹å¼å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<blockquote>
<p> Factory Pattern</p>
<p>As implied by the name, the factory pattern is responsible of factorizing (instantiating) classes. Itâ€™s widely used through the Magento code base and leverages the autoloading system in Magento. By defining an alias in a module its config.xml you are letting the factory know where it can find classes.<br>There are various factory-helper methods in the Mage core class and one of them is getModel(). It accepts an alias for a class and will then return an instance of it. Instead of having include calls scattered through the code base, the factory pattern will instantiate classes in an uniform way.</p>
</blockquote>
<h2 id="æ¨¡å¼4ï¼šå•ä¾‹æ¨¡å¼"><a href="#æ¨¡å¼4ï¼šå•ä¾‹æ¨¡å¼" class="headerlink" title="æ¨¡å¼4ï¼šå•ä¾‹æ¨¡å¼"></a>æ¨¡å¼4ï¼šå•ä¾‹æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿ï£¿</p>
<p>å¦ä¸€ç§è·å–ç±»çš„å®ä¾‹çš„æ–¹æ³•æ˜¯<code>Mage::getSingleton()</code>ï¼Œå®ƒè·Ÿ<code>Mage::getModel()</code>æ–¹æ³•ä¸€æ ·æ¥æ”¶ä¸€ä¸ªç±»çš„åˆ«åï¼Œä¸åŒä¹‹å¤„åœ¨äº<code>getSingleton</code>åœ¨è¿”å›å®ä¾‹ä¹‹å‰ï¼Œä¼šå…ˆå»æ³¨å†Œè¡¨é‡Œç„ä¸€çœ¼ï¼Œçœ‹çœ‹è¿™ä¸ªç±»æ˜¯å¦å·²ç»å®ä¾‹åŒ–è¿‡äº†ï¼Œå¦‚æœå®ä¾‹åŒ–è¿‡äº†ï¼Œé‚£è¿™ä¸ªå®ä¾‹å°±å¯ä»¥è¢«å…±äº«äº†ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒMagentoä¸­çš„sessionå¯¹è±¡ï¼Œï¼ˆå¦‚customer sessionæˆ–checkout sessionï¼‰,è¢«å‚¨å­˜åœ¨æ³¨å†Œè¡¨ä¸­ï¼Œå¯ä»¥åœ¨ä»£ç ä¸åŒåœ°æ–¹é‡å¤ä½¿ç”¨ï¼Œè€Œä¸è¦æ¯æ¬¡éƒ½é‡æ–°åˆ›å»º</p>
<blockquote>
<p>Singleton Pattern</p>
<p>Another way to retrieve an instance of a class, is to call Mage::getSingleton(). It accepts a class alias and before returning an instance, it checks the internal registry whether this class has already been instantiated before â€“ this results in a shared instance. An example of where this is mandatory, is the session storage which should be shared through the code base instead of creating it anew every time.</p>
</blockquote>
<h2 id="æ¨¡å¼5ï¼šæ³¨å†Œæ¨¡å¼"><a href="#æ¨¡å¼5ï¼šæ³¨å†Œæ¨¡å¼" class="headerlink" title="æ¨¡å¼5ï¼šæ³¨å†Œæ¨¡å¼"></a>æ¨¡å¼5ï¼šæ³¨å†Œæ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿<br>ï¼ˆè¿›ç¨‹çº§åˆ«çš„ï¼‰</p>
<p>æ‰€æœ‰çš„å•ä¾‹éƒ½å­˜å‚¨åœ¨å†…éƒ¨æ³¨å†Œè¡¨ä¸­,è¿™æ˜¯å…¨å±€çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,è€Œä¸”ä¸ä»…é™äºå†…éƒ¨ä½¿ç”¨ã€‚ä¸‹é¢åˆ—ä¸¾çš„æ³¨å†Œç›¸å…³çš„æ–¹æ³•å¯ä»¥åˆ†åˆ«å®ç°ä»æ³¨å†Œè¡¨ä¸­å­˜å‚¨ï¼ŒæŸ¥è¯¢ï¼Œåˆ é™¤æ•°æ®ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Mage::register($key,$value)     <span class="comment">//å­˜å‚¨</span></div><div class="line">Mage::registry()    <span class="comment">//æŸ¥è¯¢</span></div><div class="line">Mage::unregister()  <span class="comment">//åˆ é™¤</span></div></pre></td></tr></table></figure>
<p>è¿™ç§æ³¨å†Œè¡¨çš„æ–¹æ³•é€šå¸¸åº”ç”¨äºæ•°æ®ä¸èƒ½ä¼ é€’æ—¶çš„åœºæ™¯ä¸‹ï¼Œè¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚å¹¶ä¸”æ•°æ®æ ¼å¼æ˜¯<code>key-value</code>çš„æ ¼å¼</p>
<p>æ¯”å¦‚è®¢å•ç”Ÿæˆçš„æ—¶å€™<code>register</code>ä¸€ä¸ªkeyï¼Œç„¶ååœ¨<code>sales_order_save_after</code>äº‹ä»¶çš„<code>observer</code>æ–¹æ³•ä¸­é€šè¿‡<code>registry</code>è¯»å–ä¹‹å‰<code>register</code>çš„key</p>
<blockquote>
<p>Registry Pattern</p>
<p>All the singletons are stored in the internal registry: a global scoped Container for storing data. It is not only for internal use. The Mage::register($key, $value),::registry($key) and ::unregister($key) methods can be respectively used for storing, retrieving and removing data from the registry. The registry is often used for transferring data between scopes when they cannot be passed on, otherwise.</p>
</blockquote>
<h2 id="æ¨¡å¼6ï¼šåŸå‹æ¨¡å¼"><a href="#æ¨¡å¼6ï¼šåŸå‹æ¨¡å¼" class="headerlink" title="æ¨¡å¼6ï¼šåŸå‹æ¨¡å¼"></a>æ¨¡å¼6ï¼šåŸå‹æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿</p>
<p>åŸå‹æ¨¡å¼æ˜¯å¯¹å·¥å‚æ¨¡å¼åŠŸèƒ½çš„è¡¥å……,å®ƒå®šä¹‰ç±»çš„å®ä¾‹å¯ä»¥æ ¹æ®å…¶çˆ¶ç±»ï¼ˆåŸå‹ï¼‰æ£€ç´¢å…¶å®ƒç±»çš„å®ä¾‹ã€‚</p>
<p>ä¸¾ä¸ªæ —å­ï¼Œ<code>Mage_Catalog_Model_Product</code>ç±»æœ‰ä¸€ä¸ª<code>getTypeInstance</code>æ–¹æ³•æ¥è·å–ç‰¹å®šçš„ç±»<code>Mage_Catalog_Model_Product_Type</code>çš„å¯¹è±¡ï¼Œåè€…åŒ…å«äº†ä¸é€‚ç”¨äºå…¶å®ƒäº§å“çš„ä¸€ç³»åˆ—çš„æ–¹æ³•å’Œå±æ€§ã€‚<br>è€Œ<code>Mage_Downloadable_Model_Product_Type</code>è¿™ä¸ªDownloadableäº§å“çš„ç±»åˆæœ€ç»ˆç»§æ‰¿äº†<code>Mage_Catalog_Model_Product_Type</code>ç±»ã€‚å¦‚æœæ‚¨æ­£åœ¨ä¸‹å•å¹¶æƒ³è¦è°ƒç”¨Downloadableç±»å‹äº§å“çš„ç‰¹å®šæ–¹æ³•ï¼Œåˆ™éœ€è¦é¦–å…ˆä½¿ç”¨åŸå§‹çš„äº§å“ç±»çš„getTypeInstanceæ–¹æ³•å¯¹å…¶è¿›è¡Œå®ä¾‹åŒ–ã€‚</p>
<blockquote>
<p>Prototype Pattern</p>
<p>Where the factory pattern (#3 on our list) stops, is where the prototype pattern continues. It defines that instances of classes can retrieve a specific other class instance depending on its parent class (the prototype). A notable example is the Mage_Catalog_Model_Product class which has a getTypeInstance method to retrieve the specificMage_Catalog_Model_Product_Type with a specific subset of methods and properties not applicable to all products.<br>For example, the Mage_Downloadable_Model_Product_Type ultimately extends the Mage_Catalog_Model_Product_Type. If you are iterating over an order and want to call a specific method of a downloadable product, you will need to factorize it first with the getTypeInstance method of the original product.</p>
</blockquote>
<h2 id="æ¨¡å¼7ï¼šå¯¹è±¡æ± æ¨¡å¼"><a href="#æ¨¡å¼7ï¼šå¯¹è±¡æ± æ¨¡å¼" class="headerlink" title="æ¨¡å¼7ï¼šå¯¹è±¡æ± æ¨¡å¼"></a>æ¨¡å¼7ï¼šå¯¹è±¡æ± æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿<br>å¯¹è±¡æ± æ¨¡å¼åªæ˜¯ä¸€ä¸ªåŒ…å«å¯¹è±¡çš„é›†åˆï¼Œé˜²æ­¢å®ƒä»¬ä¸€æ¬¡åˆä¸€æ¬¡è¢«åˆ†é…å’Œé”€æ¯ã€‚</p>
<p>åœ¨Magentoä¸­ï¼Œå¯¹è±¡æ± æ¨¡å¼å¹¶ä¸å¸¸è§ï¼Œåªä¼šåœ¨å¤„ç†ä¸¥é‡å½±å“æœåŠ¡å™¨æ€§èƒ½çš„é‡ä»»åŠ¡æ—¶è¢«ä½¿ç”¨ï¼Œä¾‹å¦‚æ‰¹é‡å¯¼å…¥äº§å“çš„æ—¶å€™ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨<code>Mage::objectsï¼ˆï¼‰</code>æ–¹æ³•è®¿é—®å¯¹è±¡æ± ï¼ˆç”±<code>Varien_Object_Cache</code>ç±»ç®¡ç†ï¼‰</p>
<blockquote>
<p>Object Pool Pattern</p>
<p>The object pool pattern is simply a box with objects so that they do not have to be allocated and destroyed over and over again. Itâ€™s not used a lot in Magento other than for heavy tasks where resources can get limited soon, like importing products. The object pool (managed by Varien_Object_Cache) can be accessed with Mage::objects().</p>
</blockquote>
<h2 id="æ¨¡å¼8-è¿­ä»£å™¨æ¨¡å¼"><a href="#æ¨¡å¼8-è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="æ¨¡å¼8 è¿­ä»£å™¨æ¨¡å¼"></a>æ¨¡å¼8 è¿­ä»£å™¨æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿<br>è¿­ä»£å™¨æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªå…¬å…±æ–¹æ³•æ¥éå†å…·æœ‰å¯¹è±¡çš„ç»“åˆã€‚</p>
<p>åœ¨Magentoä¸­ï¼Œè¿™æ˜¯ç”±<code>Varien_Data_Collection</code>ç±»å®ç°çš„ï¼Œå®ƒä¾æ¬¡ä½¿ç”¨å„ç§baked-inçš„PHPç±»ï¼ˆå¦‚<code>ArrayIterator</code>ï¼‰æ¥ä¸ºæ•°ç»„æä¾›æ›´å¤šçš„OOæ¥å£ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ¨¡å‹é›†åˆå§‹ç»ˆå…·æœ‰ä¸€ä¸ªé€šç”¨çš„APIæ¥éå†ï¼Œè€Œä¸ä¾èµ–äºå®é™…çš„æ¨¡å‹ã€‚</p>
<blockquote>
<p>Iterator Pattern</p>
<p>The iterator pattern defines that there is a shared way to iterate over a container with objects. In Magento, this is handled by the Varien_Data_Collection which on its turn uses various baked-in PHP classes (like ArrayIterator) for having a more OO-interface to arrays. This ensures that model-collections will always have a common API to iterate over without being dependent of the actual models.</p>
</blockquote>
<h2 id="æ¨¡å¼9ï¼šå»¶è¿ŸåŠ è½½æ¨¡å¼"><a href="#æ¨¡å¼9ï¼šå»¶è¿ŸåŠ è½½æ¨¡å¼" class="headerlink" title="æ¨¡å¼9ï¼šå»¶è¿ŸåŠ è½½æ¨¡å¼"></a>æ¨¡å¼9ï¼šå»¶è¿ŸåŠ è½½æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿</p>
<p>å»¶è¿ŸåŠ è½½ç¡®ä¿åŠ è½½æ•°æ®è¢«å»¶è¿Ÿåˆ°å®é™…éœ€è¦çš„æ—¶é—´ç‚¹,è¿™å¯¼è‡´æ›´å°‘çš„èµ„æºåˆ©ç”¨ã€‚ Magentoçš„å»¶è¿ŸåŠ è½½è¡Œä¸ºä¹‹ä¸€å°±æ˜¯collectioné›†åˆã€‚å¦‚æœä½¿ç”¨<code>Mage::getModelï¼ˆ&#39;catalog/product&#39;)-&gt;getCollection()</code>è·å–äº§å“collectionæ—¶ï¼Œå¹¶æ²¡æœ‰æ“ä½œæ•°æ®åº“ã€‚åªæœ‰å½“loadä¹‹åï¼Œéå†collectionä¸­çš„productå¯¹è±¡æˆ–è€…æŸ¥è¯¢collectionçš„æ•°é‡æ—¶ï¼Œæ‰ä¼šå¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ“ä½œã€‚</p>
<blockquote>
<p>Lazy Loading Pattern</p>
<p>Lazy loading ensures that loading data is delayed until the point when it is actually needed. This results in less resources being used. One of the lazy loading behaviors of Magento is that of collections. If you were to retrieve a collection of products with Mage::getModel(â€˜catalog/productâ€™)-&gt;getCollection(), the database will only be touched when you actually access the collection by, for example, iterating over it or retrieving the count of models found.</p>
</blockquote>
<h2 id="æ¨¡å¼10ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼"><a href="#æ¨¡å¼10ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼" class="headerlink" title="æ¨¡å¼10ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼"></a>æ¨¡å¼10ï¼šæœåŠ¡å®šä½å™¨æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿</p>
<p>æœåŠ¡å®šä½å™¨æ¨¡å¼æŠ½å–æŸä¸ªæœåŠ¡çš„æ£€ç´¢ã€‚å®ƒéµå®ˆå…¶æŠ½è±¡åŸºç¡€ï¼Œå¯ä»¥åœ¨ä¸ç ´åä»»ä½•ä¸œè¥¿çš„æƒ…å†µä¸‹æ”¹å˜æœåŠ¡ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°é€‚åˆå…¶ç›®çš„çš„æœåŠ¡ã€‚<br>ä¾‹å¦‚ï¼ŒRyançš„æ•°æ®åº“è¿æ¥ã€‚</p>
<p>å¦ä¸€ä¸ªä¾‹å­æ˜¯Magentoçš„ç¼“å­˜æœºåˆ¶ï¼Œé€šè¿‡<code>Mage::getCache()</code>å­˜å‚¨ç¼“å­˜ï¼Œ<code>Mage::getCache()</code>æ˜¯ç”±Zendæˆ–å…¶ä»–ä¾›åº”å•†æä¾›çš„ç¼“å­˜å­˜å‚¨çš„ä»£ç†æœåŠ¡å®šä½å™¨ã€‚</p>
<p>å†å¦‚ï¼Œé˜Ÿåˆ—çš„å®ç°</p>
<blockquote>
<p>Service Locator Pattern</p>
<p>The service locator pattern abstracts away the retrieval of a certain service. This allows for changing the service without breaking anything (as it adheres to its abstract foundation) but also fetching the service as seen fit for its purpose.<br>Ryan exemplifies this with database connections. Another example is that of Magento its caching mechanism where Mage::getCache() is a service locator by-proxy for the cache storage supplied by Zend or other vendors.</p>
</blockquote>
<h2 id="æ¨¡å¼11ï¼šæ¨¡å—æ¨¡å¼"><a href="#æ¨¡å¼11ï¼šæ¨¡å—æ¨¡å¼" class="headerlink" title="æ¨¡å¼11ï¼šæ¨¡å—æ¨¡å¼"></a>æ¨¡å¼11ï¼šæ¨¡å—æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿</p>
<p>ä»»ä½•ç†Ÿæ‚‰Magentoå¼€å‘çš„äººéƒ½ä¼šå¾ˆè‡ªç„¶çš„æ¥è§¦æ¨¡å—æ¨¡å¼ã€‚å®ƒåŸºæœ¬ä¸Šå®šä¹‰äº†ä¸åŒçš„åŠŸèƒ½è¢«åˆ†ç»„æˆç‹¬ç«‹çš„æ¨¡å—ï¼Œå®ƒä»¬å½¼æ­¤ç‹¬ç«‹ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦æ’å…¥åˆ°Magentoä¸»ç³»ç»Ÿä¸­ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¨¡å—æ¨¡å¼çš„å®ç°å°†ç¡®ä¿æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥è¢«åˆ é™¤æˆ–äº¤æ¢ã€‚ PHPä¸­æ¨¡å—æ¨¡å¼çš„ä¸»è§’ä¹‹ä¸€æ˜¯Composerè½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚<br>è™½ç„¶Magentoä¸¥é‡ä¾èµ–äºæ¨¡å—åŒ–æ¶æ„ï¼Œä½†å®ƒå¹¶ä¸æ˜¯æ¨¡å—åŒ–çš„ã€‚æŸäº›åŠŸèƒ½ä¸æ ¸å¿ƒå¯†åˆ‡ç›¸å…³ï¼Œä¸èƒ½è½»æ˜“æ”¹å˜ã€‚è¿˜å¤§é‡ä½¿ç”¨è¶…å…¨å±€çš„<code>Mage</code>æ ¸å¿ƒç±»ï¼Œå¼•å…¥äº†å„ç§ä¸å—ç›‘ç®¡çš„ç³»ç»Ÿçº§ä¾èµ–å…³ç³»ã€‚</p>
<blockquote>
<p>Module Pattern</p>
<p>Anyone familiar with Magento development has stumbled upon the module pattern. It basically defines that different domains are grouped into separate modules which function independent of each other and can be plugged-in to the main system as deemed appropriate. In an ideal situation, an implementation of the module pattern would make sure that each element can be removed or swapped. One of the protagonists of the module pattern in PHP is the Composer package manager.<br>Though Magento heavily relies on a modular architecture, its not modular to the bone. Certain functionality is heavily tied to the core and can not be easily changed. There is also the heavy usage of the super-global Mage core-class which introduces all sorts of system-wide dependencies not easily overseen.</p>
</blockquote>
<h2 id="æ¨¡å¼12ï¼šè§‚å¯Ÿè€…æ¨¡å¼"><a href="#æ¨¡å¼12ï¼šè§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="æ¨¡å¼12ï¼šè§‚å¯Ÿè€…æ¨¡å¼"></a>æ¨¡å¼12ï¼šè§‚å¯Ÿè€…æ¨¡å¼</h2><p>ç®€æ˜“ç¨‹åº¦ï¼šï£¿ï£¿<br>ä½¿ç”¨åœºæ™¯ï¼šï£¿ï£¿ï£¿ï£¿ï£¿</p>
<p>Magentoçš„äº‹ä»¶é©±åŠ¨æ¶æ„æ˜¯å®ç°è§‚å¯Ÿè€…æ¨¡å¼çš„ç»“æœã€‚é€šè¿‡å®šä¹‰è§‚å¯Ÿè€…ï¼ˆæˆ–ç›‘å¬è€…ï¼‰ï¼Œå¯ä»¥æŒ‚æ¥é¢å¤–çš„ä»£ç ï¼Œéšç€è§‚å¯Ÿåˆ°çš„äº‹ä»¶è§¦å‘ï¼Œè¿™äº›ä»£ç å°†è¢«è°ƒç”¨ã€‚</p>
<p>Magentoä½¿ç”¨<code>config.xml</code>å­˜å‚¨å¹¶å®šä¹‰è§‚å¯Ÿè€…ã€‚ä½¿ç”¨<code>Mage::dispatchEventï¼ˆ$eventNameï¼Œ$dataï¼‰</code>è§¦å‘äº‹ä»¶ï¼ŒeventNameæ˜¯äº‹ä»¶åï¼Œdataæ˜¯å‚æ•°ã€‚äº‹ä»¶è§¦å‘åä¼šå°†æŸ¥è¯¢æ•°æ®å­˜å‚¨ï¼Œå¹¶è§¦å‘ç›¸åº”çš„<code>$event</code>è§‚å¯Ÿè€…ã€‚<br>é™¤äº†ä½¿ç”¨æ¨¡å—ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨äº‹ä»¶æ¥å®šåˆ¶ç°æœ‰çš„é€»è¾‘ï¼Œè€Œä¸ç”¨æ¥è§¦ç°æœ‰çš„ä»£ç ã€‚</p>
<p>ä¸¾ä¸ªæ —å­ï¼Œä¸‹å•å®Œæˆåå‘é€é‚®ä»¶é€šçŸ¥ç”¨æˆ·ï¼Œä¸éœ€è¦å°†å†™é‚®ä»¶çš„ä»£ç è·Ÿä¸‹å•çš„ä»£ç å†™åœ¨ä¸€èµ·ï¼Œåªè¦ä¸‹å•å®Œæˆåè§¦å‘äº‹ä»¶<code>sales_order_save_after</code>,åœ¨<code>config.xml</code>ä¸­å®šä¹‰<code>sales_order_save_after</code>äº‹ä»¶çš„è§‚å¯Ÿè€…ï¼Œç„¶ååœ¨è§‚å¯Ÿè€…æ–¹æ³•ä¸­å†™ç›¸åº”çš„å‘é€é‚®ä»¶çš„ä»£ç </p>
<blockquote>
<p>Observer Pattern</p>
<p>Magento its event-driven architecture is a result of an implementation of the observer pattern. By defining observers (or listeners), extra code can be hooked which will be called upon as the observed event fires. Magento uses its XML-data storage to define observers. If an event is fired with Mage::dispatchEvent($eventName, $data), the data storage will be consulted and the appropriate observers for $event will be fired.<br>In addition to using modules, events can be used to customize existing logic without touching the existing code.</p>
</blockquote>
    </div>
  </div>
  
    <div class="copy-right">
      <div class="markdown-body">
        <blockquote>
        
        
          æœ¬æ–‡ä½œè€… : å°å‡¡ <br/>
        
        åŸæ–‡é“¾æ¥ : <a href="">https://16bh.github.io/2017/03/30/12-design-patterns-in-magento/</a><br>
        ç‰ˆæƒå£°æ˜ : æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
        </blockquote>
      </div>
    </div>
  
  
  
    <div class="social-share"
  style="margin-top: -2rem"
  data-wechat-qrcode-title="<p>å¾®ä¿¡æ‰«ä¸€æ‰«</p>"
  data-wechat-qrcode-helper="<p>å¾®ä¿¡å³ä¸Šè§’, æ‰«ä¸€æ‰«åˆ†äº«</p>"
   data-sites="weibo, wechat, douban" 
  
>
  <span style="color: #6b7487; font-size: 1.4rem;">åˆ†äº«åˆ°: </span>
</div>
<script src="https://cdn.bootcss.com/social-share.js/1.0.16/js/social-share.min.js" async>
  

  
    <div id="reward">
  
    <p id="reward-meta">çŸ¥è¯† & æƒ…æ€€ | äºŒè€…å…¼å¾—</p>
  
  <button id="reward-btn">
    
    <span>æŠ•é£Ÿ</span>
  </button>
  <div id="reward-qrcode">
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/wechat.png" alt="å¾®ä¿¡æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ">
        <p class="qrcode-meta">å¾®ä¿¡æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ</p>
      </div>
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/alipay.png" alt="æ”¯ä»˜å®æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ">
        <p class="qrcode-meta">æ”¯ä»˜å®æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ</p>
      </div>
    
  </div>

</div>

<script>
  (() => {
    let button = document.querySelector('#reward-btn'),
      qrcode = document.querySelector('#reward-qrcode'),
      display = false;
    
    button.addEventListener('click', () => {
      qrcode.style.display = display ? 'none' : 'block'
      display = !display
    }, false)
  })()
</script>
  

  <div class="article-footer">
    <div class="article-meta pull-left">
      <span>
        
          <i class="iconfont icon-06tags"></i>æ ‡ç­¾: 
          
          <span class="span--tag">
            <a href="/tags/magento/">
              #magento
            </a>
          </span>
          
          <span class="span--tag">
            <a href="/tags/è®¾è®¡æ¨¡å¼/">
              #è®¾è®¡æ¨¡å¼
            </a>
          </span>
          
        
      </span>
    </div>
    <div class="article-meta pull-right">
    </div>
  </div>
</div>


  <aside id="sidebar">
    <p id="sidebar-header"></p>
    <ol id="sidebar-toc"></ol>
  </aside>
  <script async>setTimeout(generateToc, 10);</script>


  <nav class="post-navigation">
    
      <div class="nav-pre">
        <i class="iconfont icon-prev"></i>
        ä¸Šä¸€ç¯‡:
        <a href="/2017/03/30/what-does-magento&#39;s-order-model-save-function-do/" target="_self">[magento]Orderå¯¹è±¡çš„saveæ–¹æ³•æ‰§è¡Œå“ªäº›æ“ä½œï¼Ÿ</a>
      </div>
    
    
      <div class="nav-next">
        ä¸‹ä¸€ç¯‡:
        <a href="/2017/03/30/hexo-language-setting-not-effective/" target="_self">hexoè¯­è¨€è®¾ç½®æœªç”Ÿæ•ˆè§£å†³åŠæ³•</a>
        <i class="iconfont icon-next"></i>
      </div>
    
  </nav>

  
    <a href="#comment" class="comment-anchor"></a>
<div class="comment-title"><i class="iconfont icon-footprint"></i> ç•™ä¸‹è¶³è¿¹ <i class="iconfont icon-footprint"></i></div>
<div id="vcomments"></div>

<script defer>
  if( true ) {
    let path = getRealPath()
    new Valine({
      el: "#vcomments",
      appId: "NCeV64E5tzksk4EkiV7IUtYj-gzGzoHsz",
      appKey: "tajxyQiSX2markpmi5N0oImA",
      notify: false,
      verify: false,
      avatar: "robohash",
      placeholder: "æ­£ç¡®å¡«å†™é‚®ç®±, æ‰èƒ½åŠæ—¶æ”¶åˆ°å›å¤å“¦â™ª(^âˆ‡^*)",
      path
    });
  }
</script>
   

  
    <script defer>
const valineAPI = (() => {
  try {
    AV.init("NCeV64E5tzksk4EkiV7IUtYj-gzGzoHsz", "tajxyQiSX2markpmi5N0oImA");
  } catch(error) {}
  const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
      query.equalTo("identity", identity);
      query.find().then(results => {
        resolve(results.length > 0);
      }, error => reject(error));
    })
  }

  const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
      let querys = [];
      for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
      }
      query = AV.Query.or.apply(null ,querys);
    } else {
      identity = identity || getRealPath();
      query = new AV.Query("Timer");
      query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
      query.find()
      .then(results => resolve(results))
      .catch(error => reject(error))
    })
  }

  const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let Todo = AV.Object.extend('Timer');
      let todo = new Todo();
      todo.set("times", 1);
      todo.set("identity", identity);
      todo.save().then(res => resolve(true), error => reject(error));
    })
  }

  const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let query = new AV.Query('Timer');
      query.equalTo("identity", identity);
      query.find().then(todos => {
        todos.forEach(todo => {
          todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
      }).then(todos => resolve(true), error => reject(error));
    })
  }

  return {
    isExist,
    _get,
    update,
    create
  }
})()

const calcAndWriteTimes = () => {
  let isPost = true;

  let timerAllDOM = document.querySelectorAll(".article-timer");

  if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
      if(exist) {
        return valineAPI.update(identity);
      }
      return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
  }

  let timerDOMCache = {};

  for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
      timerDOMCache[identity].dom.push(timerDOM);
    }else{
      timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
      };
    }
  }

  let identities = Object.keys(timerDOMCache);
  valineAPI._get(identities).then(results => {
    for(let result of results) {
      let {identity, times} = result.attributes;
      timerDOMCache[identity].times = times;
      timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
      if(timerDOMCache[identity].times){
        continue;
      }
      timerDOMCache[identity].dom.map(item => item.innerText = 1);
      valineAPI.create(identity);
    }
  }).catch(error => console.log(error.message))
}

if(true){
  calcAndWriteTimes();
}
</script>
   

</div>


      <footer>
  <p class="site-info">
    åšå®¢å·²èŒèŒå“’è¿è¡Œ<span id="time-to-now"></span><span class="my-face">(â—'â—¡'â—)ï¾‰â™¥</span>
    <br>
    Theme - <a href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With ğŸ’— | Powered by <a href="https://godbmw.com/">GodBMW</a>
    <br>
    
  </p>
</footer>



<script>
const timeToNowDOM = document.querySelector("#time-to-now");
const startTimestamp = new Date(2015, 11, 21).getTime();

const updateTimeStr = () => {
  let offset = parseInt(
      (new Date().getTime() - startTimestamp) / 1000,
      10
    ),
    day = Math.floor(offset / 86400),
    hour = Math.floor((offset % 86400) / 3600),
    minute = Math.floor(((offset % 86400) % 3600) / 60),
    second = Math.floor(((offset % 86400) % 3600) % 60);
  timeToNowDOM.innerHTML =
    day + "å¤©" + hour + "å°æ—¶" + minute + "åˆ†é’Ÿ" + second + "ç§’";
  setTimeout(updateTimeStr, 500);
}

setTimeout(updateTimeStr, 500);
</script>


      <div class="back-to-top hidden">
  <span>
    <i class="iconfont icon-60"></i><span></span>%
  </span>
</div>

<script>
const updateIconToTop = percent => {
  let dom = document.querySelector(".back-to-top span span");
  dom.innerText = percent;
  if(percent < 1) {
    document.querySelector(".back-to-top").className = "back-to-top hidden";
  } else {
    document.querySelector(".back-to-top").className = "back-to-top";
  }
}

const handleScoll = () => {
  let isRunning = false;
  return () => {
    if (isRunning) return;
    isRunning = true;
    window.requestAnimationFrame(timestamp => {
      let scrollTop =
          document.documentElement.scrollTop || document.body.scrollTop,
        scrollHeight =
          document.documentElement.scrollHeight ||
          document.body.scrollHeight,
        clientHeight =
          document.documentElement.clientHeight ||
          document.body.clientHeight;
      isRunning = false;
      if (scrollTop <= 1) {
        updateIconToTop(0);
        return;
      }
      if (scrollTop + clientHeight >= scrollHeight) {
        updateIconToTop(100);
      } else {
        updateIconToTop(parseInt(
          100 * scrollTop / (scrollHeight - clientHeight),
          10
        ));
      }
    });
  };
}

const backToTop = () => {
  let scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop,
    delay = 10,
    time = 200;
  if (scrollTop <= 20) {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    return;
  }
  let step = Math.ceil(scrollTop * delay / time);
  let timer = setInterval(() => {
    scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop;
    if (scrollTop - step <= 0) {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      clearInterval(timer);
    } else {
      document.documentElement.scrollTop = scrollTop - step;
      document.body.scrollTop = scrollTop - step;
    }
  }, delay);
}

document.addEventListener("scroll", handleScoll(), false);

document.querySelector(".back-to-top").addEventListener("click", backToTop, false);

</script>

    </div>

    

    <script src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script>
<script async>
  let fancyTimer = setInterval(function(){
    if(!window.$){
      return;
    }
    $(document).ready(function() {
      $(".post img").each(function () {
        if($(this).parent().get(0).tagName.toLowerCase() === "a") {
          return;
        }
        // $(this).attr("data-fancybox", "gallery"); // if you add 'data-fancybox', img will display after showed
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "gallery");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      });
      
      clearInterval(fancyTimer);
    });
  }, 10);
</script>

    
  </body>

</html>
